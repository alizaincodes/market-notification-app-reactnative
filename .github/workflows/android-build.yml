name: Android CI - Build APK

on:
  push:
    branches: [ main, development ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install Android SDK command-line tools and required components
        run: |
          set -e
          # Ensure we install into the runner's HOME to avoid permission issues
          ANDROID_SDK_ROOT="$HOME/Android/Sdk"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          sudo apt-get update
          sudo apt-get install -y unzip wget
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          # download a pinned commandline tools archive
          CLI_ZIP=commandlinetools-linux-9477386_latest.zip
          wget -q https://dl.google.com/android/repository/${CLI_ZIP} -O /tmp/${CLI_ZIP}
          unzip -q /tmp/${CLI_ZIP} -d /tmp/cmdline
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          mv /tmp/cmdline/cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
          export PATH=$PATH:"$ANDROID_SDK_ROOT/cmdline-tools/latest/bin":"$ANDROID_SDK_ROOT/platform-tools"
          # install platform-tools, platform and build-tools using sdkmanager
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2"
          # accept licenses
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses || true
          echo "Installed Android SDK components to $ANDROID_SDK_ROOT"

      - name: Run Gradle assembleRelease if Android project exists
        id: build
        run: |
          set -e
          ARTIFACT_DIR="$GITHUB_WORKSPACE/artifacts"
          mkdir -p "$ARTIFACT_DIR"
          if [ -f android/gradlew ]; then
            echo "Found android/gradlew — preparing build"
            # If android/app/build.gradle exists, ensure splits block for universal APK is present
            if [ -f android/app/build.gradle ]; then
              echo "Checking android/app/build.gradle for splits..."
              if grep -q "splits\s*{" android/app/build.gradle; then
                echo "splits block already present, skipping injection"
              else
                echo "Injecting splits block to produce universal APK"
                # Insert the splits block before the first occurrence of 'buildTypes {'
                awk 'BEGIN{insert=0}
                /buildTypes\s*\{/ && insert==0 {print "        splits {\n            abi {\n                enable true\n                reset()\n                include \"armeabi-v7a\", \"arm64-v8a\", \"x86\", \"x86_64\"\n                universalApk true\n            }\n        }"; insert=1}
                {print}' android/app/build.gradle > android/app/build.gradle.tmp && mv android/app/build.gradle.tmp android/app/build.gradle
              fi
            fi

            chmod +x android/gradlew
            cd android
            # Use no-daemon to avoid hanging on CI
            ./gradlew assembleRelease --no-daemon
            cd ..
            # copy any generated APKs to artifacts dir
            cp android/app/build/outputs/apk/**/*.apk "$ARTIFACT_DIR/" || true
            echo "apk_exists=true" >> $GITHUB_OUTPUT
          else
            echo "android/gradlew not found — creating a temporary React Native project and building there"
            # Create a temporary RN project, copy JS sources, install and build
            TMP_DIR="tmp_rn_build"
            RN_VERSION="0.71.10"
            npx react-native init "$TMP_DIR" --version "$RN_VERSION" --directory "$TMP_DIR"
            # copy app JS files into temp project
            cp -r ./src "$TMP_DIR/" || true
            cp App.js index.js app.json package.json "$TMP_DIR/" || true
            # Install dependencies in temp project
            pushd "$TMP_DIR"
            # ensure correct node_modules
            npm install --no-audit --no-fund
            # inject splits block into generated android build.gradle for universal APK
            if [ -f android/app/build.gradle ]; then
              if ! grep -q "splits\s*{" android/app/build.gradle; then
                awk 'BEGIN{insert=0}
                /buildTypes\s*\{/ && insert==0 {print "        splits {\n            abi {\n                enable true\n                reset()\n                include \"armeabi-v7a\", \"arm64-v8a\", \"x86\", \"x86_64\"\n                universalApk true\n            }\n        }"; insert=1}
                {print}' android/app/build.gradle > android/app/build.gradle.tmp && mv android/app/build.gradle.tmp android/app/build.gradle
              fi
            fi
            chmod +x android/gradlew
            cd android
            ./gradlew assembleRelease --no-daemon
            cd ../..
            # copy built APKs back to artifacts
            cp "$TMP_DIR/android/app/build/outputs/apk/**/*.apk" "$ARTIFACT_DIR/" || true
            popd
            echo "apk_exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for APKs
        id: check
        run: |
          if ls artifacts/*.apk 1> /dev/null 2>&1; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload APK artifact
        if: steps.check.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: artifacts/*.apk
